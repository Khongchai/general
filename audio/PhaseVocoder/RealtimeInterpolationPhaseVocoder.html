<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <title>Document</title>
  </head>
  <body>
    <div className="container">
      <label>Speed</label>
      <input
        type="range"
        id="speed"
        min="0.6"
        max="1.5"
        value="0.7"
        step="0.01"
      />
    </div>
    <button data-playing="false" id="play-button">Play</button>
    <audio src="../tchai-short.wav"></audio>
  </body>
  <script>
    let vocoderInitializedPromiseResolve = () => {};
    const vocoderInitializedPromise = new Promise((resolve) => {
      vocoderInitializedPromiseResolve = resolve;
    });
    // @ts-check
    async function main() {
      const audioContext = new AudioContext();

      const playButton = document.getElementById("play-button");

      const audioElement = document.querySelector("audio");

      const speedControl = document.getElementById("speed");

      if (!playButton || !audioElement || !speedControl) {
        throw new Error("Some elements were not found.");
      }

      audioElement.defaultPlaybackRate = 1;
      const source = audioContext.createMediaElementSource(audioElement);
      await audioContext.audioWorklet.addModule("InterpolationVocoder.js");
      const phaseVocoder = new AudioWorkletNode(
        audioContext,
        "InterpolationVocoder"
      );
      source.connect(phaseVocoder).connect(audioContext.destination);

      playButton.addEventListener(
        "click",
        async () => {
          await vocoderInitializedPromise;
          // Check if context is in suspended state (autoplay policy)
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }

          // Play or pause track depending on state
          if (playButton.dataset.playing === "false") {
            phaseVocoder.port.postMessage({
              type: "resume",
            });
            audioElement.play();
            playButton.dataset.playing = "true";
          } else if (playButton.dataset.playing === "true") {
            phaseVocoder.port.postMessage({
              type: "pause",
            });
            audioElement.pause();
            playButton.dataset.playing = "false";
          }
        },
        false
      );

      speedControl.addEventListener("input", (event) => {
        if (!(event.target instanceof HTMLInputElement)) {
          return;
        }

        const playbackRate = event.target.value;
        phaseVocoder.port.postMessage({
          type: "playbackRate",
          playbackRate,
        });
      });

      const initialPlaybackRate = 0.7;
      phaseVocoder.port.postMessage({
        type: "initialize",
        channelCount: audioContext.destination.channelCount,
        playbackRate: 0.7,
        audioDurationInSamples: audioContext.sampleRate * audioElement.duration,
        minimumPlaybackRate: 0.6,
        // TODO @khongchai maximumPlaybackRate: 1.2,
      });

      phaseVocoder.port.onmessage = (event) => {
        if (event.data.type === "initialized") {
          vocoderInitializedPromiseResolve();
          console.log("Vocoder initialized.");
        }
      };
    }

    main();
  </script>
</html>
