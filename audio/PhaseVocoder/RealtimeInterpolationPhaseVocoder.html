<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <title>Document</title>
  </head>
  <body>
    <div className="container">
      <label>Speed</label>
      <input
        type="range"
        id="speed"
        min="0.2"
        max="1.5"
        value="1"
        step="0.01"
      />
    </div>
    <button data-playing="false" id="play-button">Play</button>
    <audio src="../tchai.wav"></audio>
  </body>
  <script>
    // @ts-check
    async function main() {
      const audioContext = new AudioContext();

      const playButton = document.getElementById("play-button");

      const audioElement = document.querySelector("audio");

      const speedControl = document.getElementById("speed");

      if (!playButton || !audioElement || !speedControl) {
        throw new Error("Some elements were not found.");
      }

      audioElement.defaultPlaybackRate = 1;
      const source = audioContext.createMediaElementSource(audioElement);
      audioElement.addEventListener("loadedmetadata", () => {
        // Calculate the time position you want to start at
        // For example, if your buffer size is 2048 and you want to start at the 2048 + 128th position
        // and assuming a sample rate of 44100 Hz
        const sampleRate = audioContext.sampleRate; // Usually 44100 Hz
        const startPosition = (2048 + 128) / sampleRate;

        // Set the starting time
        audioElement.currentTime = startPosition;
      });

      await audioContext.audioWorklet.addModule("InterpolationVocoder.js");
      const phaseVocoder = new AudioWorkletNode(
        audioContext,
        "InterpolationVocoder"
      );

      source.connect(phaseVocoder).connect(audioContext.destination);

      playButton.addEventListener(
        "click",
        () => {
          // Check if context is in suspended state (autoplay policy)
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }

          // Play or pause track depending on state
          if (playButton.dataset.playing === "false") {
            audioElement.play();
            playButton.dataset.playing = "true";
          } else if (playButton.dataset.playing === "true") {
            audioElement.pause();
            playButton.dataset.playing = "false";
          }
        },
        false
      );

      phaseVocoder.port.postMessage({
        type: "playbackRate",
        playbackRate: 1,
      });
      speedControl.addEventListener("input", (event) => {
        if (!(event.target instanceof HTMLInputElement)) {
          return;
        }

        const playbackRate = event.target.value;
        phaseVocoder.port.postMessage({
          type: "playbackRate",
          playbackRate,
        });
      });
    }

    main();
  </script>
</html>
